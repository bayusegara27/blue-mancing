<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Blue Mancing Overlay</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Inter', sans-serif;
      color: #fff;
      overflow: hidden;
      background: transparent;
    }

    .overlay {
      position: relative;
      z-index: 5;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border: 1px solid rgba(56, 198, 255, 0.15);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 30px rgba(56, 198, 255, 0.1);
      display: flex;
      flex-direction: column;
      padding: 8px 10px;
      width: 240px;
      background: linear-gradient(145deg, rgba(15, 25, 45, 0.92), rgba(8, 15, 30, 0.95));
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .overlay.minimized {
      height: 32px !important;
      min-height: 32px !important;
      overflow: hidden;
    }

    .overlay.minimized .overlay-content {
      display: none;
    }

    /* Draggable header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 2px;
      cursor: move;
      user-select: none;
      -webkit-app-region: drag;
    }

    .title-section {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-icon {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #38c6ff, #00ff88);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
    }

    .title {
      font-size: 11px;
      font-weight: 600;
      color: #38c6ff;
      text-shadow: 0 0 8px rgba(56, 198, 255, 0.4);
      letter-spacing: 0.3px;
    }

    .window-controls {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }

    .window-btn {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      transition: all 0.18s ease;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .window-btn:hover {
      background: rgba(0, 255, 255, 0.06);
      box-shadow: 0 0 8px rgba(0, 200, 255, 0.25);
      color: #fff;
    }

    .window-btn.minimize:hover {
      background: rgba(56, 198, 255, 0.15);
      border-color: rgba(56, 198, 255, 0.3);
      color: #38c6ff;
    }

    .window-btn.close:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.4);
      color: #f87171;
    }

    .overlay-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    /* Controls */
    .controls-row {
      display: flex;
      gap: 4px;
    }

    .control-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 5px 8px;
      font-size: 10px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-start {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.15));
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }

    .btn-start:hover {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.35), rgba(34, 197, 94, 0.25));
      transform: translateY(-1px);
    }

    .btn-stop {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.15));
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #f87171;
    }

    .btn-stop:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.35), rgba(239, 68, 68, 0.25));
      transform: translateY(-1px);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.03);
      padding: 4px 8px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .stat-item i {
      font-size: 10px;
      width: 14px;
    }

    .stat-label {
      font-size: 9px;
      color: rgba(255, 255, 255, 0.5);
      flex: 1;
      margin-left: 6px;
    }

    .stat-value {
      font-size: 11px;
      font-weight: 600;
    }

    .stat-value.green { color: #4ade80; }
    .stat-value.red { color: #f87171; }
    .stat-value.cyan { color: #22d3ee; }
    .stat-value.teal { color: #2dd4bf; }

    .fa-fish { color: #4ade80; }
    .fa-xmark { color: #f87171; }
    .fa-star { color: #22d3ee; }
    .fa-percent { color: #2dd4bf; }

    /* Status Bar */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 6px;
      padding: 6px 8px;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
      box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
      transition: all 0.3s ease;
    }

    .status-dot.running {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .status-text {
      font-size: 10px;
      font-weight: 600;
      color: #f87171;
    }

    .status-text.running {
      color: #4ade80;
    }

    .timer {
      font-size: 10px;
      color: #60a5fa;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    /* Activity - collapsible */
    .activity-section {
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .activity-section.hidden {
      display: none;
    }

    .activity-box {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 5px;
      padding: 5px 8px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .activity-label {
      font-size: 8px;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .activity-text {
      font-size: 9px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Debug toggle */
    .debug-toggle {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-top: 4px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      margin-top: 4px;
    }

    .debug-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.3);
      font-size: 8px;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 3px;
      transition: all 0.2s;
    }

    .debug-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
    }

    .debug-btn.active {
      color: #38c6ff;
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay">
    <!-- Draggable Header -->
    <div class="header" id="drag-header">
      <div class="title-section">
        <div class="title-icon"><i class="fa-solid fa-fish"></i></div>
        <span class="title">Blue Mancing</span>
      </div>
      <div class="window-controls">
        <button id="minimize-btn" class="window-btn minimize" title="Minimize"><i class="fa-solid fa-minus"></i></button>
        <button id="close-btn" class="window-btn close" title="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>

    <!-- Collapsible Content -->
    <div class="overlay-content" id="overlay-content">
      <!-- Controls -->
      <div class="controls-row">
        <button id="start-btn" class="control-btn btn-start">
          <i class="fa-solid fa-play"></i>
          <span>Start</span>
        </button>
        <button id="stop-btn" class="control-btn btn-stop">
          <i class="fa-solid fa-stop"></i>
          <span>Stop</span>
        </button>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-item">
          <i class="fa-solid fa-fish"></i>
          <span class="stat-label">Catches</span>
          <span id="stat-catches" class="stat-value green">0</span>
        </div>
        <div class="stat-item">
          <i class="fa-solid fa-xmark"></i>
          <span class="stat-label">Misses</span>
          <span id="stat-misses" class="stat-value red">0</span>
        </div>
        <div class="stat-item">
          <i class="fa-solid fa-star"></i>
          <span class="stat-label">XP</span>
          <span id="stat-xp" class="stat-value cyan">0</span>
        </div>
        <div class="stat-item">
          <i class="fa-solid fa-percent"></i>
          <span class="stat-label">Rate</span>
          <span id="stat-rate" class="stat-value teal">0%</span>
        </div>
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-left">
          <div id="status-dot" class="status-dot"></div>
          <span id="status-text" class="status-text">Stopped</span>
        </div>
        <span id="timer" class="timer">00:00:00</span>
      </div>

      <!-- Debug/Activity Section -->
      <div class="activity-section" id="activity-section">
        <div class="activity-box">
          <div class="activity-label">Activity</div>
          <div id="activity" class="activity-text">Waiting for start...</div>
        </div>
      </div>

      <!-- Debug Toggle -->
      <div class="debug-toggle">
        <button id="debug-toggle-btn" class="debug-btn active" title="Toggle debug info">
          <i class="fa-solid fa-bug"></i> Debug
        </button>
      </div>
    </div>
  </div>

  <script>
    const overlay = document.getElementById('overlay');
    const overlayContent = document.getElementById('overlay-content');
    const indicator = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const timer = document.getElementById('timer');
    const closeBtn = document.getElementById('close-btn');
    const minimizeBtn = document.getElementById('minimize-btn');
    const activityEl = document.getElementById('activity');
    const activitySection = document.getElementById('activity-section');
    const debugToggleBtn = document.getElementById('debug-toggle-btn');
    const dragHeader = document.getElementById('drag-header');

    let startTime = null;
    let elapsedTime = 0;
    let timerInterval = null;
    let botRunning = false;
    let isMinimized = false;
    let debugVisible = true;

    // Drag functionality
    let isDragging = false;
    let dragStartX, dragStartY;

    dragHeader.addEventListener('mousedown', function(e) {
      if (e.target.closest('.window-controls')) return;
      e.preventDefault();
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      document.body.style.cursor = 'move';
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      e.preventDefault();
      const dx = e.clientX - dragStartX;
      const dy = e.clientY - dragStartY;
      // For native window dragging, send move request to Rust
      sendToRust('drag', { dx, dy });
    });

    document.addEventListener('mouseup', function() {
      isDragging = false;
      document.body.style.cursor = '';
    });

    // IPC handler for wry - sends message to Rust backend
    function sendToRust(action, data = {}) {
      if (window.ipc) {
        window.ipc.postMessage(JSON.stringify({ action: action, ...data }));
      }
    }

    // Called from Rust to update the UI with bot state
    window.updateFromRust = function(data) {
      // Update stats
      if (data.stats) {
        document.getElementById('stat-catches').textContent = data.stats.catches || 0;
        document.getElementById('stat-misses').textContent = data.stats.misses || 0;
        document.getElementById('stat-xp').textContent = data.stats.xp || 0;
        document.getElementById('stat-rate').textContent = (data.stats.rate || '0') + '%';
      }

      // Update running status
      const wasRunning = botRunning;
      botRunning = data.running;

      // Use shared function to update UI
      setRunningState(botRunning, wasRunning);

      // Update activity text with detailed status
      if (data.activity) {
        let activityText = data.activity;
        if (data.detail && data.detail.length > 0) {
          activityText = data.detail;
        }
        activityEl.textContent = activityText;
      }
    };

    // Shared function to update running state UI
    function setRunningState(running, wasRunning, statusOverride) {
      if (running) {
        indicator.classList.add('running');
        statusText.classList.remove('stopped');
        statusText.classList.add('running');
        statusText.textContent = statusOverride || 'Running';

        // Start timer if just started
        if (!wasRunning) {
          startTime = new Date() - elapsedTime;
          if (!timerInterval) {
            timerInterval = setInterval(updateTimer, 1000);
          }
        }
      } else {
        indicator.classList.remove('running');
        statusText.classList.remove('running');
        statusText.classList.add('stopped');
        statusText.textContent = statusOverride || 'Stopped';

        // Pause timer if just stopped (don't reset)
        if (wasRunning && startTime) {
          elapsedTime = new Date() - startTime;
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
    }

    // Legacy function for backward compatibility
    window.toggleBotStatus = function(state) {
      const isRunning = state === 'running';
      window.updateFromRust({ running: isRunning, activity: isRunning ? 'Running' : 'Stopped' });
    };

    window.updateStats = function(data) {
      window.updateFromRust({ stats: data, running: botRunning });
    };

    function updateTimer() {
      if (!startTime) return;
      const diff = new Date() - startTime;
      const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
      const m = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
      const s = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
      timer.textContent = `${h}:${m}:${s}`;
    }

    // Button click handlers
    document.getElementById('start-btn').addEventListener('click', function() {
      sendToRust('start');
      if (!botRunning) {
        const wasRunning = botRunning;
        botRunning = true;
        setRunningState(true, wasRunning, 'Starting...');
        activityEl.textContent = 'Initializing...';
        startTime = new Date();
        elapsedTime = 0;
      }
    });

    document.getElementById('stop-btn').addEventListener('click', function() {
      sendToRust('stop');
      if (botRunning) {
        const wasRunning = botRunning;
        botRunning = false;
        setRunningState(false, wasRunning, 'Stopping...');
        activityEl.textContent = 'Bot stopped by user';
      }
    });

    // Minimize functionality
    minimizeBtn.addEventListener('click', function() {
      isMinimized = !isMinimized;
      if (isMinimized) {
        overlay.classList.add('minimized');
        minimizeBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
        minimizeBtn.title = 'Expand';
      } else {
        overlay.classList.remove('minimized');
        minimizeBtn.innerHTML = '<i class="fa-solid fa-minus"></i>';
        minimizeBtn.title = 'Minimize';
      }
    });

    closeBtn.addEventListener('click', function() {
      sendToRust('close');
    });

    // Debug toggle
    debugToggleBtn.addEventListener('click', function() {
      debugVisible = !debugVisible;
      if (debugVisible) {
        activitySection.classList.remove('hidden');
        debugToggleBtn.classList.add('active');
      } else {
        activitySection.classList.add('hidden');
        debugToggleBtn.classList.remove('active');
      }
    });

    // Update overlay settings from dashboard (called from Rust)
    window.updateOverlaySettings = function(settings) {
      // Handle show debug setting
      if (typeof settings.showDebug !== 'undefined') {
        debugVisible = settings.showDebug;
        if (debugVisible) {
          activitySection.classList.remove('hidden');
          debugToggleBtn.classList.add('active');
        } else {
          activitySection.classList.add('hidden');
          debugToggleBtn.classList.remove('active');
        }
      }
    };

    // Legacy pywebview compatibility
    window.pywebview = {
      api: {
        start_script: function() { sendToRust('start'); },
        stop_script: function() { sendToRust('stop'); },
        minimize_window: function() { sendToRust('minimize'); },
        close_window: function() { sendToRust('close'); }
      }
    };

    // Initial state
    activityEl.textContent = 'Waiting for start...';
  </script>
</body>
</html>
